---
title: "Processing experts shortlists"
author: 
  - Damiano Oldoni
  - Tim Adriaens
date: "`r Sys.Date()`"
output:
  html_document:
  toc: true
toc_depth: 3
toc_float: true
number_sections: true
theme: yeti
df_print: paged
knit: (function(input_file, encoding) { rmarkdown::render(input_file, encoding = encoding, output_file = paste0("../docs/",sub(".Rmd", ".html", basename(input_file))))})
---
  
```{r global_options, include = FALSE}
knitr::opts_chunk$set(root.dir = "../",
                      warning=FALSE, 
                      message=FALSE)
```

# Load libraries

```{r load_libraries}
# Work with googlesheets
library(googlesheets)

# Tidyverse packages
library(dplyr)
library(stringr)
library(readr)
library(tidyr)
library(purrr)
library(magrittr)
```

# Import spreadsheets

The experts receive a spreadsheet with a *longlist* of alien or possible future aliens. The experts can take into account species out this longlist as well. They are invited to select around 10 species individually. This judge independency is achieved by making individual spreadsheets which are not globally shared with all experts community. This strategy is at the moment experimented within vertebrates group. 

The Google spreadsheets are called `ias_UKOT_vertebrates_firstname_surname.tsv` and contain two sheets, `LONGLIST` and `SHORLIST`. 
The shortlist is structured as follows:

|species|country|remarks (optional)|
| --- | --- | --- |
|example1|KY, AI, BM|remark1|
|example2|AI, BM, MS, TC, VG, KY|remark2|
|example3|TC|...|
|    |    |    |

The columns `species` and  `country` are mandatory while `remarks` is optional.
Countries should be comma separated values as shown in the table above and should contain one or more of the 6 Caribbean UKOTs.

We select the spreadsheets to import:

```{r select_spreadsheets}
experts <- c("Elena_Tricarico",
             "Fred_Burton",
             "Ian_Winfield",
             "Jane_Haakonsson_Sophie_Oâ€™Hehir",
             "Latisha_Martin",
             "Mark_Outerbridge",
             "Nancy_Pascoe",
             "Rose-Smyth_Christine",
             "Jason_Berry",
             "Bryan_Manco",
             "Tim_Adriaens")
gss_experts <- str_c("ias_UKOT_vertebrates_", experts, ".tsv")
my_sheets <- gs_ls()
experts_ss <- my_sheets %>% 
  filter(sheet_title %in% gss_experts)
experts_ss <- map_dfr(unique(experts_ss$sheet_title), 
                      function(x) experts_ss %>% 
                        filter(sheet_title == x) %>%
                        filter(updated == max(updated)))
experts_ss$sheet_title
```

We import the experts' shortlists by these spreadsheets:

```{r import_spreadsheets, results= "hide"}
title_ssheets <- map(experts_ss$sheet_title, ~ gs_title(.))
dfs_experts <- map(
  title_ssheets, ~ gs_read(ss = ., ws = "SHORTLIST")
)
names(dfs_experts) <- experts_ss %>% pull(sheet_title)
```

First, we save the most updated version of the shortlists in the directory `./data/raw/`:

```{r save_raw_shortlists, results = "hide"}
map(names(dfs_experts), ~ write_tsv(dfs_experts[[.]], 
                                    path = paste0("../data/raw/", .)))
```

An example from the shortlist of one expert:

```{r explore}
dfs_experts[[4]]
```


Tidy the dataframes (one row per species per country):

```{r tidy_dfs}
dfs_experts <- map(dfs_experts, function(x) x %>%
                     mutate(UKOTs = str_replace_all(UKOTs, 
                                                pattern = " ",
                                                replace = "")))
dfs_experts <- map(dfs_experts, 
                   function(x) x %<>% 
                     separate_rows(UKOTs, sep = ","))
dfs_experts <- map(names(dfs_experts),
                   function(x) dfs_experts[[x]] %<>%
                     mutate(expert = x))
```

We can now combine the information provided by all experts:

```{r combine_dfs_experts}
combined_dfs <- bind_rows(dfs_experts)
combined_counts_species <- combined_dfs %>% group_by(species, 
                                                     UKOTs) %>%
  count() %>%
  ungroup() %>% 
  distinct()

# combined_counts_species %<>% 
#   rowwise() %>%
#   mutate(remarks = paste((combined_dfs %>% 
#            filter(species  == .$species) %>% 
#            select(`remarks (optional)`) %>% 
#              filter(!is.na(`remarks (optional)`)) %>% 
#              distinct() %>% pull()), 
#            collapse = ";")) %>% 
#   ungroup() %>%
#   distinct()
```

Which species are present in the combined shorlist?

```{r general_species_list}
general_species_list <- combined_counts_species %>% 
  arrange(desc(n)) %>%
  filter(!species == "Dummy Dummy")
```

To a better overview, let's spread by UKOTs:

```{r spread_table}
general_species_list_spread <- spread(general_species_list, key = UKOTs, value = n)
general_species_list_spread
```

And save it:

```{r save_spread_table}
write_tsv(general_species_list_spread, path = "../data/output/general_species_list_spread.tsv")
```


It could be also important to have an overview of species combined with the number of experts who judge them present in the horizon. In case the same species has different number of assessors for different UKOTs, take the maximum.

```{r species_number_experts}
overview_species <- general_species_list %>% 
  group_by(species) %>% 
  summarize(n_experts = max(n)) %>%
  arrange(desc(n_experts))
overview_species
```

Let's save it in `../data/output/first_round_as_UKOTs.tsv`:

```{r write_general_species_list}
write_tsv(overview_species,
          path = "../data/output/first_round_as_UKOTs.tsv")
```

# Focus on shortlists

Experts should now start to set scores for species in the combined shortlist. In order to help them in doing it, we provide them a selection of the unified checklist with GBIF number of occurrences based on the species in the combined shorlist. 

First we have to get the cleaned and complete longlist which has been saved as a googlesheet as explained in `workflow_retrieve_GBIF_checklist_dplyr.Rmd`:

```{r get_most_udpated_longlist, results = "hide"}
my_sheets <- gs_ls()
google_ssheet <- my_sheets %>% 
  filter(str_detect(my_sheets$sheet_title, 
                    pattern = "ias_UKOT_vertebrates_invertebrates"))
google_ssheet %<>%
  filter(updated == max(google_ssheet$updated)) # take the most recent version
unified_checklist_vert <- gs_key(google_ssheet$sheet_key) %>% gs_read(ws = "LONGLIST")
```

We select the species which are in the shortlists:

```{r}
combined_shortlist_occ <- unified_checklist_vert %>%
  filter(Species %in% general_species_list$species)
combined_shortlist_occ
```

We save it as an output in order to share it with experts for starting scoring:

```{r save_checklist_occ_filtered_by_shortlist}
write_tsv(
  combined_shortlist_occ, 
  path = "../data/filter_combined_shortlist_from_unified_checklist.tsv")
```

